<!DOCTYPE html>
<html>
<head>
<title>图书信息编辑</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />

<script src="../../scripts/boot.js" type="text/javascript"></script>
<link href="../../demo/demo.css" rel="stylesheet" type="text/css" />

<style type="text/css">
html, body {
	padding: 0;
	margin: 0;
	border: 0;
	height: 100%;
	overflow: hidden;
}
</style>
</head>
<body>

	<form id="form1" method="post">
		<input name="bookId" class="mini-hidden" />
		<fieldset style="border: solid 1px #aaa; padding: 3px;">
			<legend>修改图书信息</legend>
			<div style="padding: 5px;">
				<table>
					<tr>
						<td style="width: 80px">图书名称：</td>
						<td style="width: 150px"><input name="bookName"
							class="mini-textbox" emptyText="请输入图书名称" required="true"
							readOnly="true" /></td>

						<td style="width: 80px">出版社：</td>
						<td style="width: 150px"><input name="publisher"
							class="mini-textbox" required="true" /></td>
					</tr>
					<tr>
						<td style="width: 80px">作者：</td>
						<td style="width: 150px"><input name="author"
							class="mini-textbox" required="true" readOnly="true" /></td>

						<td style="width: 80px">图书类别：</td>
						<td><input name="bookType" class="mini-combobox"
							url="../../data/booktype.txt" /></td>
					</tr>
					<tr>
						<td align="right">剩余数量：</td>
						<td><input name="remain" class="mini-spinner" minValue="1"
							maxValue="200" readOnly="true" /></td>
					</tr>
				</table>
			</div>
		</fieldset>
		<div style="text-align: center; padding: 10px;">
			<a class="mini-button" onclick="onOk"
				style="width: 60px; margin-right: 20px;">确定</a> <a
				class="mini-button" onclick="onCancel" style="width: 60px;">取消</a>
		</div>
	</form>
	<script type="text/javascript">
        mini.parse();


        var form = new mini.Form("form1");

        //保存数据
        function SaveData() {
            var o = form.getData();            

            form.validate();
            if (form.isValid() == false){
            	return;
            }

            var json = mini.encode(o);
            $.ajax({
                url: "../../bookinfoeditaction?method=updatebookinfo",
		        type: 'post',
                data: { data: json },
                cache: false,
                success: function (text) {
                    mini.alert(text, "提示：", function(){
                        CloseWindow("save");
                    })	
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    alert(jqXHR.responseText);
                    CloseWindow();
                }
            });
        }

        //打开修改时填入表单数据
        function setData(data){
        	//页面之间传递数据需要克隆后使用
        	data = mini.clone(data);

            $.ajax({
                url: "../../bookinfoeditaction?method=querybookinfobyid&bookid=" + data.bookId,
                cache: false,
                success: function (text) {
                    var o = mini.decode(text);
                    form.setData(o);
                    form.setChanged(false);//设置当前表单为未修改
                }
            });
        }
        
        //关闭窗口
        function CloseWindow(action) {            
            if (window.CloseOwnerWindow){
            	return window.CloseOwnerWindow(action);
            }
            else{
            	return window.close();            
            }
        }
        function onOk(e) {
            SaveData();
        }

        
        //点击取消按钮后提示“数据被修改了是否保存”
        function onCancel() {            
            if (form.isChanged()) {
            	mini.confirm("数据被修改了，是否先保存？","提醒", function (action){
            		console.log(action);
            		//action点击确定是ok，点取消是cancel
            		if(action == "ok"){
            			SaveData();
            		}else{
            			CloseWindow("cancel");
            		}
            	});
            }else{
            	CloseWindow("cancel");
            }
        }

    </script>
</body>
</html>